<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155099641-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());      
      gtag('config', 'UA-155099641-1');
    </script>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@adokoy0001" />
<meta name="twitter:creator" content="@adokoy0001" />
<meta property="og:title" content="FuelPHPのDeployerによるデプロイ" />
<meta property="og:description" content="Deployerによるレシピについて。" />

<!--    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/css/bootstrap.min.css" rel="stylesheet"> -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>FuelPHPのDeployerによるデプロイ - NIKKI.YOKODA.OKINAWA</title>
    

  </head>
  <body>
    <style>
      .container-fluid {
      padding-right: 15px;
      padding-left: 15px;
      }
      h1 {font-size: 2.30em;}
      h2 {font-size: 1.90em;}
      h3 {font-size: 1.50em;}
      pre { background-color: #E0E0E0; border: 1px solid #303030; padding: 0.7em; margin: 0.7em;}
    </style>
    <div class="container-fluid">
      <header class="container">
	<a href="/">TOP</a> | <a href="/tags.html">TAG LIST</a> | <a href="/archive.html">ARCHIVES</a>
      </header>
      <hr>
      <section>
	<div class="container">
	  


<h1>FuelPHPのDeployerによるデプロイ</h1>

<p>以前お話したPHPのデプロイについて、Deployerというツールを使ってDSLを書いてみたところいい感じだった。
会社のプロダクトではFuelPHPというWAFを使っているが、レシピはcommonなもので十分だった。</p>

<p>まずはDeployer公式サイト : &lt;https://deployer.org/&gt;</p>

<p>インストールは公式に書いてある通りでOK。</p>

<pre><code>    curl -LO https://deployer.org/deployer.phar
    mv deployer.phar /usr/local/bin/dep
    chmod +x /usr/local/bin/dep
</pre></code>

<p>前提条件としては、デプロイスクリプトを実行するマシンは、
アプリサーバーに公開鍵認証でsshログインできることと、
sudoコマンドでパスワードを聞かれないこと、
apacheの設定でユーザーディレクトリの設定を済ませていることぐらい（必要なコマンドだけnopassにしてください）。</p>

<p>デプロイ対象サーバーの設定として、以下のような形式で設定を書き込む。</p>

<pre><code>    set('application', 'app'); # アプリサーバーのアプリ展開path等に使う。

    host('999.999.000.999')       # リモートホストの指定。複数指定も可能（当たり前か）
        -&gt;stage('production')
        -&gt;user('app_user')        # リモートホストのユーザー名。
        -&gt;set('branch','master')  # pullしてデプロイする対象のブランチ
        -&gt;set('deploy_path', '~/{{application}}');  # デプロイ対象path


    ## /home/app_user/app/以下のデプロイされたディレクトリにwww-dataへのアクセス権を与えるためのタスクを定義
    desc('chown deployment dir');
    task('deploy:chown_dir', function () {
        $target_dir = '~/{{application}}/current';
        $res1 = run("sudo chown -h app_user:www-data $target_dir");
        $res2 = run("sudo chown -hR app_user:www-data $target_dir/");
        $res3 = run("sudo chown -R app_user:www-data $target_dir/");
    });

    desc('My Application Deployment');
    task('deploy', [
        'deploy:info',
        'deploy:prepare',
        'deploy:lock',
        'deploy:release',
        'deploy:update_code',
        'deploy:shared',
        'deploy:writable',
        'deploy:vendors',
        'deploy:clear_paths',
        'deploy:symlink',
        'deploy:chown_dir',    # これが追加されたタスク
        'deploy:unlock',
        'cleanup',
        'success'
    ]);
</pre></code>

<p>アプリケーションはリモートの/home/app_user/appに展開され、/home/app_user/app/currentのシンボリックリンクが指し示すディレクトリが最新のものになる。</p>

<p>デプロイスクリプトが置かれたディレクトリで以下のコマンドを実行すれば、アプリが展開される（うまい具合にcomposer updateなどもちゃんと実行される）</p>

<pre><code>    $ dep deploy production
</pre></code>



<hr>

<section>
<ul>
<li> <a href="/tags/0ff5f88d5173497b0aeb546d3f96e446.html">Deployer</a></li>
<li> <a href="/tags/2c54d42a778a7d30706f2eabc4a338ca.html">deployer</a></li>
<li> <a href="/tags/11fc3960fd795c40a1de9c92ce16b3b6.html">PHP</a></li>
<li> <a href="/tags/196875532e56e08bc3aa8e7328cb2232.html">php</a></li>
<li> <a href="/tags/337141a52adccec6e5888f8beb50b4d0.html">FuelPHP</a></li>
<li> <a href="/tags/84159968353d6b18aab13908ffdb7af7.html">fuelphp</a></li>
<li> <a href="/tags/e0b67df2172af0189a1d61573a74b0ba.html">デプロイツール</a></li>
</ul>

</section>

<section>
  prev: <a href="/entry/2019/11/2019_11_28_001.html">MySQL（InnoDB）のロックとトランザクション</a> <br>
  next: <a href="/entry/2019/11/2019_11_29_002.html">PHPのarrayから再帰的にkeyとvalueを全て取り出す</a> <br>
</section>

<section>
  created at : 2020-04-02 11:01:38<br>
  updated at : 2020-04-02 11:01:38<br>
  author : Toshiaki Yokoda<br>
</section>

	</div>
      </section>
      <footer>
      </footer>
    </div>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!--    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script>$(function(){$('pre > code').addClass('prettyprint');});</script>
  </body>
</html>
